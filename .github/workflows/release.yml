name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    name: Build and Release Binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Build all platform binaries
      run: |
        echo "ğŸ”¨ Building GhE standalone executables..."
        mkdir -p build

        # Build for Linux x64
        echo "ğŸ§ Building for Linux x64..."
        bun build --compile --target=bun-linux-x64 --minify --sourcemap --outfile build/ghe ./index.ts

        # Build for Linux ARM64
        echo "ğŸ§ Building for Linux ARM64..."
        bun build --compile --target=bun-linux-arm64 --minify --sourcemap --outfile build/ghe-linux-arm64 ./index.ts

        # Build for Windows x64
        echo "ğŸªŸ Building for Windows x64..."
        bun build --compile --target=bun-windows-x64 --minify --sourcemap --outfile build/ghe.exe ./index.ts

        # Build for macOS x64
        echo "ğŸ Building for macOS x64..."
        bun build --compile --target=bun-darwin-x64 --minify --sourcemap --outfile build/ghe-macos ./index.ts

        # Build for macOS ARM64
        echo "ğŸ Building for macOS ARM64..."
        bun build --compile --target=bun-darwin-arm64 --minify --sourcemap --outfile build/ghe-macos-arm64 ./index.ts

        echo "âœ… All builds completed!"

    - name: Generate checksums
      run: |
        echo "ğŸ“Š Generating checksums..."
        cd build
        sha256sum * > ../checksums.txt
        cd ..
        cat checksums.txt

    - name: Get release info
      id: release_info
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "tag_name=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          echo "release_name=GhE ${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
        else
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          echo "release_name=GhE ${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: Repository metadata
      id: repo
      run: |
        OWNER="${GITHUB_REPOSITORY%/*}"
        NAME="${GITHUB_REPOSITORY#*/}"
        echo "owner=$OWNER" >> "$GITHUB_OUTPUT"
        echo "name=$NAME" >> "$GITHUB_OUTPUT"

    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.release_info.outputs.tag_name }}
        name: ${{ steps.release_info.outputs.release_name }}
        body: |
          # ğŸ‰ GhE Release - ${{ steps.release_info.outputs.tag_name }}

          **Beautiful GitHub Account Switcher - Standalone Binaries**

          ## ğŸ“¦ Downloads

          Choose the appropriate binary for your platform:

          | Platform | Binary | Size |
          |----------|--------|------|
          | ğŸ§ **Linux x64** | [`ghe`](https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe) | ~100MB |
          | ğŸ§ **Linux ARM64** | [`ghe-linux-arm64`](https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe-linux-arm64) | ~93MB |
          | ğŸªŸ **Windows x64** | [`ghe.exe`](https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe.exe) | ~114MB |
          | ğŸ **macOS Intel** | [`ghe-macos`](https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe-macos) | ~64MB |
          | ğŸ **macOS Apple Silicon** | [`ghe-macos-arm64`](https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe-macos-arm64) | ~58MB |

          ## ğŸš€ Quick Start

          ### One-line installation:
          ```bash
          curl -fsSL https://raw.githubusercontent.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/main/install.sh | bash
          ```

          ### Manual installation:
          1. Download the binary for your platform
          2. Make it executable: `chmod +x ghe` (Linux/macOS)
          3. Run: `./ghe`

          ### Global installation:
          ```bash
          # Linux/macOS
          sudo cp ghe /usr/local/bin/

          # Windows (as Administrator)
          copy ghe.exe C:\Windows\System32\
          ```

          ## âœ¨ Features

          - ğŸ¨ **Beautiful terminal interface** with colors and animations
          - ğŸ”„ **Multi-account GitHub switching** per repository
          - ğŸ” **Dual authentication support**: SSH keys and Personal Access Tokens
          - ğŸ¯ **Active account detection** - see which account is currently active
          - ğŸ§ª **Connection testing** - verify GitHub connectivity
          - âš¡ **Zero dependencies** - single executable file
          - ğŸ–¥ï¸ **Cross-platform** - works on Linux, Windows, and macOS

          ## ğŸ“‹ Usage Examples

          ```bash
          # Start GhE
          ./ghe

          # Add a new GitHub account
          # Choose: â• Add account

          # Switch account for current repository
          # Choose: ğŸ”„ Switch account for current repo

          # Test GitHub connection
          # Choose: ğŸ§ª Test connection

          # List all configured accounts
          # Choose: ğŸ“‹ List accounts
          ```

          ## ğŸ”§ Verification

          Verify the integrity of your download using checksums:
          - Download [`checksums.txt`](https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/checksums.txt)
          - Run: `sha256sum -c checksums.txt`

          ## ğŸ“š Documentation

          - [README.md](https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/blob/main/README.md) - Complete documentation
          - [DISTRIBUTION.md](https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/blob/main/DISTRIBUTION.md) - Distribution guide

          ---

          **Full Changelog**: https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/compare/${{ steps.release_info.outputs.tag_name }}^...${{ steps.release_info.outputs.tag_name }}
        draft: false
        prerelease: false
        files: |
          build/ghe
          build/ghe-linux-arm64
          build/ghe.exe
          build/ghe-macos
          build/ghe-macos-arm64
          checksums.txt
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update installation script URLs
      run: |
        echo "âœ… Release created successfully!"
        echo "ğŸ“¦ Binaries uploaded to: https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/tag/${{ steps.release_info.outputs.tag_name }}"
        echo ""
        echo "ğŸ”— Download links:"
        echo "- Linux x64: https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe"
        echo "- Linux ARM64: https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe-linux-arm64"
        echo "- Windows x64: https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe.exe"
        echo "- macOS Intel: https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe-macos"
        echo "- macOS Apple Silicon: https://github.com/${{ steps.repo.outputs.owner }}/${{ steps.repo.outputs.name }}/releases/download/${{ steps.release_info.outputs.tag_name }}/ghe-macos-arm64"
